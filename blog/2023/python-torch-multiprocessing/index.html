<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Multiprocessing in PyTorch | Yuhang Ming</title> <meta name="author" content="Yuhang Ming"> <meta name="description" content="study notes of multiprocessing in pytorch. references see below."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/icon.png"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://yuhangming.github.io/blog/2023/python-torch-multiprocessing/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Yuhang </span>Ming</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Multiprocessing in PyTorch</h1> <p class="post-meta">April 24, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/programming"> <i class="fas fa-hashtag fa-sm"></i> programming</a>     ·   <a href="/blog/category/mix-posts"> <i class="fas fa-tag fa-sm"></i> mix-posts</a>   </p> </header> <article class="post-content"> <h1 id="table-of-content">Table of Content</h1> <ul> <li><a href="#references">References</a></li> <li><a href="#thread-vs-process">Thread vs. Process</a></li> <li> <a href="#life-cycle-of-a-process">Life-cycle of a Process</a> <ul> <li><a href="#new-child-process">New child process</a></li> <li> <a href="#running-process">Running process</a> <ul> <li><a href="#spawm">spawm</a></li> <li><a href="#fork">fork</a></li> <li><a href="#forkserver">forkserver</a></li> </ul> </li> <li><a href="#blocked-process-optional">Blocked process (optional)</a></li> <li><a href="#terminated-process">Terminated process</a></li> </ul> </li> <li> <a href="#basic-usage">Basic Usage</a> <ul> <li><a href="#run-a-function-in-a-process">Run a Function in a Process</a></li> <li><a href="#communication-exchanging-objects-between-processes">Communication (Exchanging objects) between processes</a></li> <li><a href="#synchronization-between-processes">Synchronization between processes</a></li> </ul> </li> <li><a href="#advanced-usage">Advanced Usage</a></li> </ul> <h1 id="references">References</h1> <p><a href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" rel="external nofollow noopener" target="_blank">python-docs</a>; <a href="https://pytorch.org/docs/stable/multiprocessing.html" rel="external nofollow noopener" target="_blank">torch-docs</a>; <a href="https://tokudayo.github.io/multiprocessing-in-python-and-torch/" rel="external nofollow noopener" target="_blank">ref-0</a>; <a href="https://superfastpython.com/multiprocessing-in-python/" rel="external nofollow noopener" target="_blank">ref-1</a>; <a href="https://www.digitalocean.com/community/tutorials/python-multiprocessing-example" rel="external nofollow noopener" target="_blank">ref-2</a>.</p> <p><code class="language-plaintext highlighter-rouge">torch.multiprocessing</code> is a wrapper around the native <code class="language-plaintext highlighter-rouge">multiprocessing</code> module. It registers custom reducers, that use shared memory to provide shared views on the same data in different processes. Once the tensor/storage is moved to shared_memory (see <code class="language-plaintext highlighter-rouge">share_memory_()</code>), it will be possible to send it to other processes without making any copie</p> <p>The API is 100% compatible with the original module - it’s enough to change <code class="language-plaintext highlighter-rouge">import multiprocessing</code> to <code class="language-plaintext highlighter-rouge">import torch.multiprocessing</code> to have all the tensors sent through the queues or shared via other mechanisms, moved to shared memory.</p> <p>Check the pytorch practice <a href="https://pytorch.org/docs/stable/notes/multiprocessing.html" rel="external nofollow noopener" target="_blank">here</a> for more details.</p> <h1 id="thread-vs-process">Thread vs. Process</h1> <p>A process refers to a computer program. In Python a process is in fact one instance of the python interpreter that executes python instructinos (byte-code, not the code written in the program).</p> <p>A thread always exists within a process and represents the manner in which instructions or code is executed. A process will have at least one thread, called the main thread. Any additional threads that we create within the process will belong to that process.</p> <p>More on this see <a href="https://superfastpython.com/thread-vs-process" rel="external nofollow noopener" target="_blank">here</a>.</p> <h1 id="life-cycle-of-a-process">Life-cycle of a Process</h1> <p>A process in Python is represented as an instance of the <code class="language-plaintext highlighter-rouge">multiprocessing.Process</code> class.</p> <p>The life-cycle of a process is as follows:</p> <h2 id="new-child-process">New child process</h2> <p>It is a process that has been constructed and configured by creating an instance of the <code class="language-plaintext highlighter-rouge">multiprocessing.Process</code> class.</p> <h2 id="running-process">Running process</h2> <p>A new process can transition to a running process by calling the start() method. This also creates and starts the main thread for the process that actually executes code in the process.</p> <p>There are three main techniques used to create a child process, referred to as process start methods. They are: <strong>spawm</strong>, <strong>fork</strong>, and <strong>forkserver</strong>.</p> <h3 id="spawm">spawm</h3> <p>The parent process starts fresh Python interpreter process. The child process will only inherit those resources necessary to run the process object’s run() method. In particular, unnecessary file descriptors and handles from the parent process will not be inherited. <em>Note that starting a process using this method is rather slow compared to using fork or forkserver.</em>. <strong>Default on Windows and MacOS</strong>.</p> <h3 id="fork">fork</h3> <p>The parent process uses <code class="language-plaintext highlighter-rouge">os.fork()</code> to fork the Python interpreter. The child process, when it begins, is effectively <strong>identical</strong> to the parent process. All resources of the parent are inherited by the child process. <em>Note that safely forking a multithreaded process is problematic.</em> <strong>Default on Unix</strong>.</p> <h3 id="forkserver">forkserver</h3> <p>When the program starts and selects the <strong>forkserver</strong> start method, a server process is started. From then on, whenever a new process is needed, the parent process connects to the server and requests that it fork a new process. The fork server process is single threaded so it is safe for it to use <code class="language-plaintext highlighter-rouge">os.fork()</code>. No unnecessary resources are inherited.</p> <h2 id="blocked-process-optional">Blocked process (optional)</h2> <p>A running process may block in many ways if its main thread is blocked, such as reading or writing from a file or a socket or by waiting on a concurrency primitive such as a semaphore or a lock. After blocking, the process will run again.</p> <h2 id="terminated-process">Terminated process</h2> <p>A process may terminate once it has finished executing its code or by raising an error or exception. Note that a process cannot be terminate until:</p> <ul> <li>All non-daemon threads have terminated, including the main thread.</li> <li>All non-daemon child processes have terminated, including the main process.</li> </ul> <h1 id="basic-usage">Basic Usage</h1> <h2 id="run-a-function-in-a-process">Run a Function in a Process</h2> <p>To run a function in another process:</p> <ol> <li>Select a start method with <code class="language-plaintext highlighter-rouge">set_start_method()</code>.</li> <li>Create an instance of the <code class="language-plaintext highlighter-rouge">multiprocessing.Process</code> class.</li> <li>Specify the name of the function via the “<strong>target</strong>” argument. The function executed in another process may have arguments in which case they can be specified as a <em>tuple</em> and passed to the “<strong>args</strong>” argument of the <code class="language-plaintext highlighter-rouge">multiprocessing.Process</code> class constructor or as a <em>dictionary</em> to the “<strong>kwargs</strong>” argument.</li> <li>Call the <code class="language-plaintext highlighter-rouge">start()</code> function.</li> <li>We can explicitly wait for the new process to finish executing by calling the <code class="language-plaintext highlighter-rouge">join()</code> function.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">mp</span><span class="p">.</span><span class="nf">set_start_method</span><span class="p">(</span><span class="sh">'</span><span class="s">spawn</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">))</span>
    <span class="c1"># run the process
</span>    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="c1"># wait for the process to finish
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Waiting for the process to finish...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
</code></pre></div></div> <h2 id="communication-exchanging-objects-between-processes">Communication (Exchanging objects) between processes</h2> <ol> <li><code class="language-plaintext highlighter-rouge">Queue()</code></li> <li> <code class="language-plaintext highlighter-rouge">Pipe()</code> ```python import multiprocessing as mp</li> </ol> <p>def foo(q, i): q.put(f’hello from process {i}’)</p> <p>if <strong>name</strong> == ‘<strong>main</strong>’: mp.set_start_method(‘spawn’) # create data holder q = mp.Queue() procs = [] for i in range(10): # print(i) # create a new process p = mp.Process(target=foo, args=(q, i)) procs.append(p) # run the process p.start() # get data print(q.qsize()) # Because of multiprocessing semantics, this number is not reliable. for i in range(10): print(q.get()) # wait for the process to finish print(“Waiting for the process to finish…”) for p in procs: p.join()</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Synchronization between processes
Use `Lock()`. It allows code to claim lock so that no other process can execute the similar code until the lock has be released. 
To claim lock the, acquire() function is used and to release lock release() function is used.

```python
import multiprocessing as mp

def foo(l, q, i):
    l.acquire()
    try:
        q.put(f'hello from process {i}')
    finally:
        l.release()

if __name__ == '__main__':
    mp.set_start_method('spawn')
    lock = mp.Lock()

    # create data holder
    q = mp.Queue()
    procs = []
    for i in range(10)
        # create a new process
        p = mp.Process(target=foo, args=(lock, q, i))
        procs.append(p)
        # run the process
        p.start()
    # get data
    print(q.get())
    # wait for the process to finish
    print("Waiting for the process to finish...")
    for p in procs:
        p.join()
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">Lock()</code> vs. <code class="language-plaintext highlighter-rouge">RLock()</code>:</p> <p>The main difference is that a <code class="language-plaintext highlighter-rouge">Lock</code> can only be acquired once. It cannot be acquired again, until it is released. (After it’s been released, it can be re-acaquired by any thread).</p> <p>An <code class="language-plaintext highlighter-rouge">RLock</code> on the other hand, can be acquired multiple times, by the same thread. It needs to be released the same number of times in order to be “unlocked”.</p> <p>Another difference is that an acquired <code class="language-plaintext highlighter-rouge">Lock</code> can be released by any thread, while an acquired <code class="language-plaintext highlighter-rouge">RLock</code> can only be released by the thread which acquired it.</p> <p>An example can be found here: <a href="https://stackoverflow.com/questions/22885775/what-is-the-difference-between-lock-and-rlock" rel="external nofollow noopener" target="_blank">stackoverflow</a>.</p> <h2 id="share-state-between-processes">Share State between processes</h2> <p>When donig concurrent programming, it is usually the best to avoid using shared state as far as possible. Especially when there are lots of processes.</p> <h3 id="shared-memory">Shared Memory</h3> <p>Data can be stored in a shared memory map using <code class="language-plaintext highlighter-rouge">Value()</code> or <code class="language-plaintext highlighter-rouge">Array()</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Array</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">n</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">3.1415927</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nc">Value</span><span class="p">(</span><span class="sh">'</span><span class="s">d</span><span class="sh">'</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="nc">Array</span><span class="p">(</span><span class="sh">'</span><span class="s">i</span><span class="sh">'</span><span class="p">,</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">arr</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="n">num</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">arr</span><span class="p">[:])</span>
</code></pre></div></div> <h3 id="server-process">Server Process</h3> <p>A manager object returned by <code class="language-plaintext highlighter-rouge">Manager()</code> controls a server process which holds Python objects and allows other processes to manipulate them using proxies. It supports types <code class="language-plaintext highlighter-rouge">list</code>, <code class="language-plaintext highlighter-rouge">dict</code>, <code class="language-plaintext highlighter-rouge">Namespace</code>, <code class="language-plaintext highlighter-rouge">Lock</code>, <code class="language-plaintext highlighter-rouge">RLock</code>, <code class="language-plaintext highlighter-rouge">Semaphore</code>, <code class="language-plaintext highlighter-rouge">BoundedSemaphore</code>, <code class="language-plaintext highlighter-rouge">Condition</code>, <code class="language-plaintext highlighter-rouge">Event</code>, <code class="language-plaintext highlighter-rouge">Barrier</code>, <code class="language-plaintext highlighter-rouge">Queue</code>, <code class="language-plaintext highlighter-rouge">Value</code> and <code class="language-plaintext highlighter-rouge">Array</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Manager</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span>
    <span class="n">d</span><span class="p">[</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">d</span><span class="p">[</span><span class="mf">0.25</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">l</span><span class="p">.</span><span class="nf">reverse</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">with</span> <span class="nc">Manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">dict</span><span class="p">()</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

        <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

        <span class="nf">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</code></pre></div></div> <h1 id="advanced-usage">Advanced Usage</h1> <p>Customized managers and proxies</p> <p>The <code class="language-plaintext highlighter-rouge">Proxy</code> objects used by <code class="language-plaintext highlighter-rouge">multiprocessing.BaseManager</code> and its sub-classes normally only expose methods from the objects they’re referring to, not attributes.</p> <p>To allow access for access and assign attributes in the class, use the following sharing proxy:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">NamespaceProxy</span>

<span class="k">class</span> <span class="nc">ShareDataProxy</span><span class="p">(</span><span class="n">NamespaceProxy</span><span class="p">):</span>
    <span class="n">_exposed_</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">__getattribute__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">__setattr__</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <p>More can be found <a href="https://devpress.csdn.net/python/630456a0c67703293080b6d1.html" rel="external nofollow noopener" target="_blank">here</a></p> <p>Examples from the official doc. By default, the methods starts with <code class="language-plaintext highlighter-rouge">_</code> is also inaccessible.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">freeze_support</span>
<span class="kn">from</span> <span class="n">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span><span class="p">,</span> <span class="n">BaseProxy</span>
<span class="kn">import</span> <span class="n">operator</span>

<span class="c1">##
</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">you called Foo.f()</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">you called Foo.g()</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_h</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">you called Foo._h()</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># A simple generator function
</span><span class="k">def</span> <span class="nf">baz</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span><span class="o">*</span><span class="n">i</span>

<span class="c1"># Proxy type for generator objects
</span><span class="k">class</span> <span class="nc">GeneratorProxy</span><span class="p">(</span><span class="n">BaseProxy</span><span class="p">):</span>
    <span class="n">_exposed_</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">__next__</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span>
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_callmethod</span><span class="p">(</span><span class="sh">'</span><span class="s">__next__</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Function to return the operator module
</span><span class="k">def</span> <span class="nf">get_operator_module</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">operator</span>

<span class="c1">##
</span>
<span class="k">class</span> <span class="nc">MyManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># register the Foo class; make `f()` and `g()` accessible via proxy
</span><span class="n">MyManager</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="sh">'</span><span class="s">Foo1</span><span class="sh">'</span><span class="p">,</span> <span class="n">Foo</span><span class="p">)</span>

<span class="c1"># register the Foo class; make `g()` and `_h()` accessible via proxy
</span><span class="n">MyManager</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="sh">'</span><span class="s">Foo2</span><span class="sh">'</span><span class="p">,</span> <span class="n">Foo</span><span class="p">,</span> <span class="n">exposed</span><span class="o">=</span><span class="p">(</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">_h</span><span class="sh">'</span><span class="p">))</span>

<span class="c1"># register the generator function baz; use `GeneratorProxy` to make proxies
</span><span class="n">MyManager</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="sh">'</span><span class="s">baz</span><span class="sh">'</span><span class="p">,</span> <span class="n">baz</span><span class="p">,</span> <span class="n">proxytype</span><span class="o">=</span><span class="n">GeneratorProxy</span><span class="p">)</span>

<span class="c1"># register get_operator_module(); make public functions accessible via proxy
</span><span class="n">MyManager</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="sh">'</span><span class="s">operator</span><span class="sh">'</span><span class="p">,</span> <span class="n">get_operator_module</span><span class="p">)</span>

<span class="c1">##
</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="nc">MyManager</span><span class="p">()</span>
    <span class="n">manager</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">f1</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nc">Foo1</span><span class="p">()</span>
    <span class="n">f1</span><span class="p">.</span><span class="nf">f</span><span class="p">()</span>
    <span class="n">f1</span><span class="p">.</span><span class="nf">g</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="sh">'</span><span class="s">_h</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">f1</span><span class="p">.</span><span class="n">_exposed_</span><span class="p">)</span> <span class="o">==</span> <span class="nf">sorted</span><span class="p">([</span><span class="sh">'</span><span class="s">f</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">])</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">f2</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nc">Foo2</span><span class="p">()</span>
    <span class="n">f2</span><span class="p">.</span><span class="nf">g</span><span class="p">()</span>
    <span class="n">f2</span><span class="p">.</span><span class="nf">_h</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="sh">'</span><span class="s">f</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">f2</span><span class="p">.</span><span class="n">_exposed_</span><span class="p">)</span> <span class="o">==</span> <span class="nf">sorted</span><span class="p">([</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">_h</span><span class="sh">'</span><span class="p">])</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">baz</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;%d&gt;</span><span class="sh">'</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">op</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="nf">operator</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">op.add(23, 45) =</span><span class="sh">'</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">op.pow(2, 94) =</span><span class="sh">'</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">94</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">op._exposed_ =</span><span class="sh">'</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="n">_exposed_</span><span class="p">)</span>

<span class="c1">##
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">freeze_support</span><span class="p">()</span>
    <span class="nf">test</span><span class="p">()</span>
</code></pre></div></div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Yuhang Ming. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <div style="height:1px"> <script type="text/javascript" id="clustrmaps" src="//clustrmaps.com/map_v2.js?d=sP5zK6ZHzsC7pQB6E9e6ewkUE27-89S1-RjTxkJHOJM&amp;cl=ffffff&amp;w=400"></script> </div> </body> </html>